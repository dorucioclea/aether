language: python

python:
  - "2.7"

services:
  - docker

env:
  global:
    - DOCKER_IMAGE_REPO: 387526361725.dkr.ecr.eu-west-1.amazonaws.com
    - PROJECT_NAME: gather2
    - AWS_REGION: eu-west-1

cache:
  directories:
    - $HOME/.cache/pip

install:
  - pip install flake8
  - pip install -r pip-deploy.txt

before_script:
  - flake8
  - docker-compose up -d db
  - docker-compose run core setuplocaldb

script:
  - docker-compose run core test_coverage

after_success:
  - git clone "https://${GH_USER}:${GH_TOKEN}@github.com/eHealthAfrica/beanstalk-deploy" .ebextensions

deploy:
  - provider: script
    script: ./scripts/deploy.sh "gather2-core-dev"
    skip_cleanup: true
    on:
      branch: master
